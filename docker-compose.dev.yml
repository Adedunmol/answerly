#services:
#  app:
#    depends_on:
#      postgres:
#        condition: service_healthy
#      redis:
#        condition: service_healthy
#    build:
#      context: .
#      target: dev-stage
#
#    container_name: answerly-app
#    hostname: answerly-app
#    networks:
#      - answerly
#    ports:
#      - ${PORT}:5001
#    env_file: ".env"
#    deploy:
#      restart_policy:
#        condition: on-failure
#  #    volumes:
#  #      - .:/app
#  #      - /app/tmp
#
#  postgres:
#    env_file: ".env"
#    extends:
#      service: postgres
#      file: docker-compose.base.yml
#
#  redis:
#    env_file: ".env"
#    extends:
#      service: redis
#      file: docker-compose.base.yml
#
#networks:
#  answerly:
#    driver: bridge
#
#volumes:
#  postgres-data:

services:
  app:
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    build:
      context: .
      dockerfile: Dockerfile
      target: dev-stage
    container_name: answerly-app
    hostname: answerly-app
    networks:
      - answerly
    ports:
      - "${PORT:-5001}:5001"
    env_file:
      - .env
    restart: on-failure
    # Mount code for hot reload
    volumes:
      - .:/app
      - /app/tmp  # Anonymous volume to prevent mounting tmp folder
      - go-modules:/go/pkg/mod  # Cache Go modules
    environment:
      - PORT=5001
      - ENV=development

  postgres:
    extends:
      service: postgres
      file: docker-compose.base.yml
    env_file:
      - .env

  redis:
    extends:
      service: redis
      file: docker-compose.base.yml
    env_file:
      - .env

networks:
  answerly:
    driver: bridge

volumes:
  postgres-data:
  go-modules:  # Named volume for Go modules cache